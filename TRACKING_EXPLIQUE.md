# üìä Comment fonctionne le syst√®me de tracking

## üéØ Architecture Globale

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         UTILISATEUR                             ‚îÇ
‚îÇ                    (utilise l'application)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚îÇ Actions (upload photo, change √©tape...)
                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FRONTEND (React/Next.js)                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚Ä¢ PostHogProvider.tsx  ‚Üê Initialise PostHog au d√©marrage      ‚îÇ
‚îÇ  ‚Ä¢ lib/analytics.ts     ‚Üê Module centralis√©                    ‚îÇ
‚îÇ  ‚Ä¢ track('event')       ‚Üê Fonction simple √† appeler            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                 ‚îÇ                        ‚îÇ
                 ‚îÇ track('photo_uploaded')‚îÇ
                 ‚ñº                        ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   PostHog.com      ‚îÇ    ‚îÇ  /api/analytics/   ‚îÇ
    ‚îÇ  (Temps r√©el)      ‚îÇ    ‚îÇ  track (backup DB) ‚îÇ
    ‚îÇ  - Dashboards      ‚îÇ    ‚îÇ                    ‚îÇ
    ‚îÇ  - Funnels         ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ  - Session Replay  ‚îÇ             ‚îÇ
    ‚îÇ  OPTIONNEL         ‚îÇ             ‚îÇ Sauvegarde
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚ñº
                             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                             ‚îÇ  PostgreSQL/SQLite   ‚îÇ
                             ‚îÇ  Table:              ‚îÇ
                             ‚îÇ  AnalyticsEvent      ‚îÇ
                             ‚îÇ  - userId            ‚îÇ
                             ‚îÇ  - eventType         ‚îÇ
                             ‚îÇ  - metadata (JSON)   ‚îÇ
                             ‚îÇ  - createdAt         ‚îÇ
                             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚îÇ
                                        ‚îÇ Lecture
                                        ‚ñº
                             ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                             ‚îÇ  /api/analytics/     ‚îÇ
                             ‚îÇ  dashboard           ‚îÇ
                             ‚îÇ  (calcule m√©triques) ‚îÇ
                             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ Flux d'un √©v√©nement

### Exemple : Utilisateur uploade une photo

```
1. FRONTEND (app/page.tsx)
   ‚Üì
   processPhotoAsync() termine avec succ√®s
   ‚Üì
   track('photo_uploaded', {
     photoId: '123',
     roomType: 'salon',
     duration_ms: 2500
   })

2. MODULE ANALYTICS (lib/analytics.ts)
   ‚Üì
   Fonction track() fait 2 choses EN PARALL√àLE:
   
   A) PostHog (si configur√©)
      ‚Üì
      window.posthog.capture('photo_uploaded', {...})
      ‚Üì
      Envoy√© vers PostHog.com (dashboards temps r√©el)
   
   B) API Backup
      ‚Üì
      fetch('/api/analytics/track', {
        userId: 'user-abc',
        eventType: 'photo_uploaded',
        metadata: { photoId, roomType, duration_ms }
      })

3. API BACKEND (app/api/analytics/track/route.ts)
   ‚Üì
   Re√ßoit la requ√™te
   ‚Üì
   prisma.analyticsEvent.create({
     userId: 'user-abc',
     eventType: 'photo_uploaded',
     metadata: { ... }
   })
   ‚Üì
   Sauvegard√© en base de donn√©es

4. R√âSULTAT
   ‚úÖ √âv√©nement enregistr√© en DB
   ‚úÖ Visible dans PostHog (si activ√©)
   ‚úÖ Peut √™tre consult√© via /api/analytics/dashboard
```

---

## üß© Composants Principaux

### 1Ô∏è‚É£ **PostHogProvider.tsx** (Frontend)

**R√¥le** : Initialiser PostHog au d√©marrage de l'app

```typescript
useEffect(() => {
  // Initialise PostHog UNE FOIS au chargement
  if (apiKey && typeof window !== 'undefined') {
    posthog.init(apiKey, {
      api_host: 'https://app.posthog.com',
      capture_pageviews: true,  // Track pages automatiquement
      autocapture: false         // On track manuellement
    });
    
    // Identifier l'utilisateur
    const userId = localStorage.getItem('moverz_user_id');
    if (userId) {
      posthog.identify(userId);
    }
  }
}, []);
```

**R√©sultat** : `window.posthog` est disponible partout

---

### 2Ô∏è‚É£ **lib/analytics.ts** (Module central)

**R√¥le** : API simple pour tracker des √©v√©nements

```typescript
// Fonction principale
export function track(
  eventType: 'photo_uploaded' | 'step_reached' | ...,
  metadata?: { photoId: string, roomType: string, ... }
): void {
  
  // 1. PostHog (temps r√©el)
  if (window.posthog) {
    window.posthog.capture(eventType, metadata);
  }
  
  // 2. Backup DB (via API)
  fetch('/api/analytics/track', {
    method: 'POST',
    body: JSON.stringify({ userId, eventType, metadata })
  }).catch(() => {}); // Silencieux si √©chec
}
```

**Pourquoi 2 destinations ?**
- **PostHog** : Dashboards visuels, session replay, temps r√©el
- **DB** : Backup, compliance, requ√™tes SQL custom

**Important** : Si track() √©choue, √ßa ne casse JAMAIS l'app (catch silencieux)

---

### 3Ô∏è‚É£ **app/api/analytics/track/route.ts** (API)

**R√¥le** : Sauvegarder les √©v√©nements en base de donn√©es

```typescript
export async function POST(req: NextRequest) {
  const { userId, eventType, metadata } = await req.json();
  
  // Sauvegarde en DB
  await prisma.analyticsEvent.create({
    data: { userId, eventType, metadata }
  });
  
  return NextResponse.json({ success: true });
}
```

**R√©sultat** : Chaque √©v√©nement est persist√© dans PostgreSQL

---

### 4Ô∏è‚É£ **app/api/analytics/dashboard/route.ts** (API)

**R√¥le** : Calculer et retourner les m√©triques

```typescript
export async function GET(req: NextRequest) {
  // Calcule les m√©triques des 7 derniers jours
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
  
  // 1. Utilisateurs actifs
  const activeUsers = await prisma.analyticsEvent.groupBy({
    by: ['userId'],
    where: { createdAt: { gte: sevenDaysAgo } }
  });
  
  // 2. Funnel de conversion
  const stepEvents = await prisma.analyticsEvent.findMany({
    where: { 
      eventType: 'step_reached',
      createdAt: { gte: sevenDaysAgo }
    }
  });
  
  // Calculer utilisateurs par √©tape
  const funnel = [1,2,3,4,5].map(step => {
    const users = new Set(
      stepEvents
        .filter(e => e.metadata?.step === step)
        .map(e => e.userId)
    );
    return { step, users: users.size };
  });
  
  return NextResponse.json({
    metrics: { ... },
    funnel,
    ai: { ... }
  });
}
```

**R√©sultat** : JSON avec toutes les m√©triques cl√©s

---

## üìä Table AnalyticsEvent (Base de donn√©es)

```sql
CREATE TABLE "AnalyticsEvent" (
  "id" TEXT PRIMARY KEY,
  "userId" TEXT NOT NULL,          -- Qui a fait l'action ?
  "eventType" TEXT NOT NULL,       -- Quelle action ?
  "metadata" JSONB,                -- D√©tails (JSON flexible)
  "createdAt" TIMESTAMP NOT NULL   -- Quand ?
);
```

**Exemple de donn√©es** :

| id | userId | eventType | metadata | createdAt |
|----|--------|-----------|----------|-----------|
| abc123 | user-42 | `app_opened` | `{}` | 2025-01-12 10:30:00 |
| def456 | user-42 | `photo_uploaded` | `{"photoId":"xyz","roomType":"salon","duration_ms":2500}` | 2025-01-12 10:31:15 |
| ghi789 | user-42 | `step_reached` | `{"step":2}` | 2025-01-12 10:32:00 |

**Pourquoi JSONB pour metadata ?**
- Flexible : chaque √©v√©nement peut avoir des m√©tadonn√©es diff√©rentes
- Queryable : PostgreSQL peut filtrer dans le JSON
- Extensible : on peut ajouter des champs sans migration

---

## üéØ Points d'instrumentation (o√π on track)

### **app/page.tsx** (Frontend)

```typescript
// 1. Ouverture app
useEffect(() => {
  track('app_opened', { userId });
}, []);

// 2. Upload photo
processPhotoAsync() {
  // ... upload
  track('photo_uploaded', {
    photoId,
    roomType,
    confidence,
    duration_ms
  });
}

// 3. Changement d'√©tape
handleStepChange(step) {
  setCurrentStep(step);
  trackStep(step); // Helper qui appelle track('step_reached', {step})
}

// 4. Validation pi√®ces
handleRoomValidationComplete(roomGroups) {
  track('room_validation_completed', {
    roomCount: roomGroups.length,
    totalPhotos: ...
  });
}

// 5. Envoi devis
handleSubmitQuote() {
  // ... envoi
  track('quote_submitted', {
    projectId,
    batchId,
    photosCount,
    roomCount
  });
}
```

**Principe** : On track APR√àS le succ√®s de l'action (jamais avant)

---

## üîí S√©curit√© & Vie priv√©e

### Ce qui est track√© :
‚úÖ Actions utilisateur (√©tapes, uploads...)  
‚úÖ M√©triques techniques (dur√©e, erreurs...)  
‚úÖ userId (anonyme, g√©n√©r√© al√©atoirement)  

### Ce qui N'est PAS track√© :
‚ùå Donn√©es personnelles (email, t√©l√©phone...)  
‚ùå Contenu des photos  
‚ùå Informations du formulaire devis  

### Stockage :
- **Base de donn√©es** : Chez toi (contr√¥le total)
- **PostHog** : UE disponible (RGPD compliant)

---

## üöÄ Avantages de cette architecture

### 1. **Fire & Forget**
```typescript
track('photo_uploaded', {...});
// Si √ßa √©choue, l'app continue normalement
```
‚Üí Le tracking ne peut JAMAIS casser l'app

### 2. **Double Backup**
- PostHog tombe ? ‚Üí DB continue
- DB pleine ? ‚Üí PostHog continue

### 3. **Maintenance Z√©ro**
- Pas de cron jobs
- Pas de workers
- Pas de cleanup manuel
- Tout est automatique

### 4. **Extensible**
Ajouter un nouvel √©v√©nement :

```typescript
// 1. Ajouter le type
type AnalyticsEventType = 
  | 'photo_uploaded'
  | 'mon_nouvel_event'; // ‚Üê Ajouter ici

// 2. Tracker n'importe o√π
track('mon_nouvel_event', { data: 'test' });

// 3. C'est tout ! ‚úÖ
```

---

## üí° Cas d'usage typiques

### **1. D√©bugger un probl√®me utilisateur**

```sql
-- Voir ce qu'a fait un utilisateur sp√©cifique
SELECT 
  "eventType",
  metadata,
  "createdAt"
FROM "AnalyticsEvent"
WHERE "userId" = 'user-probleme'
ORDER BY "createdAt" DESC;
```

### **2. Analyser un drop-off**

```sql
-- Voir o√π les utilisateurs abandonnent
SELECT 
  metadata->>'step' as step,
  COUNT(DISTINCT "userId") as users
FROM "AnalyticsEvent"
WHERE "eventType" = 'step_reached'
GROUP BY step
ORDER BY step;

-- R√©sultat :
-- step 1: 100 users (100%)
-- step 2: 85 users  (85%)
-- step 3: 60 users  (60%)  ‚Üê 25% drop ici !
-- step 4: 55 users  (55%)
-- step 5: 50 users  (50%)
```

### **3. Mesurer performance IA**

```sql
-- Dur√©e moyenne d'upload par type de pi√®ce
SELECT 
  metadata->>'roomType' as room_type,
  AVG((metadata->>'duration_ms')::int) as avg_duration_ms
FROM "AnalyticsEvent"
WHERE "eventType" = 'photo_uploaded'
GROUP BY room_type;

-- R√©sultat :
-- salon:   2300ms
-- chambre: 1800ms
-- cuisine: 3100ms ‚Üê Plus lent !
```

---

## üéì R√©sum√© Simple

1. **User fait une action** ‚Üí Upload photo
2. **Frontend** appelle `track('photo_uploaded', {...})`
3. **Module analytics** envoie vers :
   - PostHog (dashboards jolis)
   - API backend (backup DB)
4. **API backend** sauvegarde en DB
5. **Dashboard API** lit la DB et calcule les m√©triques
6. **Toi** tu consultes :
   - `/api/analytics/dashboard` (JSON)
   - PostHog.com (graphiques)
   - Prisma Studio (explorer donn√©es)

**C'est tout !** Simple, fiable, maintenable. üéâ

